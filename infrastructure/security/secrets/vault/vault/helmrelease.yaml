apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: vault
  namespace: vault
spec:
  interval: 5m
  chart:
    spec:
      chart: vault
      version: 0.30.0
      sourceRef:
        kind: HelmRepository
        name: hashicorp
        namespace: flux-system
  values:
  # https://artifacthub.io/packages/helm/hashicorp/vault
  # https://github.com/hashicorp/vault-helm/blob/main/values.yaml
    server:
      ingress:
        enabled: true
        annotations:
          forecastle.stakater.com/expose: "true"
          forecastle.stakater.com/icon: "https://icon.icepanel.io/Technology/svg/HashiCorp-Vault.svg"
          forecastle.stakater.com/appName: "Hashicorp Vault"
          forecastle.stakater.com/group: "Security"
        hosts:
        - host: vault.127.0.0.1.nip.io
          paths: 
          - /
        tls:
        - secretName: mkcert-tls-secret
          hosts:
          - vault.127.0.0.1.nip.io
      postStart:
      - /bin/sh
      - -c
      - /vault/userconfig/init/init.sh
      extraEnvironmentVars:
        VAULT_AUTO_UNSEAL_KEY_0: pikakube
      volumes:
      - name: vault-init
        configMap:
          name: vault-init
          defaultMode: 0755
      volumeMounts:
      - name: vault-init
        mountPath: /vault/userconfig/init
      dataStorage:
        size: 2Gi
      auditStorage:
        enabled: true
        size: 2Gi
    injector:
      enabled: false
    csi: 
      enabled: false
    ui:
      enabled: true
    serverTelemetry:
      serviceMonitor:
        enabled: true
