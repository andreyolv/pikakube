apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: dex
  namespace: dex
spec:
  interval: 5m
  chart:
    spec:
      chart: dex
      version: 0.19.0
      sourceRef:
        kind: HelmRepository
        name: dex
        namespace: flux-system
  valuesFrom:
  - kind: Secret
    name: postgres
    valuesKey: password
    targetPath: config.storage.config.password
  values:
  # https://artifacthub.io/packages/helm/dex/dex
  # https://github.com/dexidp/helm-charts/blob/master/charts/dex/values.yaml
    config:
      issuer: https://dex.example.com:32000/dex
      web:
        https: 0.0.0.0:5556
        tlsCert: /etc/dex/tls/tls.crt
        tlsKey: /etc/dex/tls/tls.key
      storage:
        type: postgres
        config:
          host: postgres
          port: 5432
          database: dex_db
          user: dex
      connectors:
      - type: github
        id: github
        name: GitHub
        config:
          clientID: $GITHUB_CLIENT_ID
          clientSecret: $GITHUB_CLIENT_SECRET
          redirectURI: http://127.0.0.1:5556/dex/callback
          orgs:
          - name: andreyolv
            teams:
              - admin