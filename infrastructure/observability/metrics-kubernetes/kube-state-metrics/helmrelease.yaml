apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kube-state-metrics
  namespace: kube-system
spec:
  interval: 5m
  chart:
    spec:
      chart: kube-state-metrics
      version: 5.19.0
      sourceRef:
        kind: HelmRepository
        name: prometheus-community
        namespace: flux-system
  values:
  # https://artifacthub.io/packages/helm/prometheus-community/kube-state-metrics
  # https://github.com/prometheus-community/helm-charts/blob/main/charts/kube-state-metrics/values.yaml
    rbac: 
      extraRules:
      - apiGroups: [ "raizen.com" ]
        resources: [ "*" ]
        verbs: ["list","watch"]
    customResourceState:
      enabled: true
      config:
        kind: CustomResourceStateMetrics
        spec:
          resources:
          - groupVersionKind:
              group: raizen.com
              version: "v1alpha1"
              kind: "*"
            metricNamePrefix: crossplane_compositeresources
            commonLabels:
              custom_metric: "yes"
            labelsFromPath:
              name: ["metadata", "name"]
              namespace: [metadata, namespace]   
            metrics:
            - name: status_ready
              help: "Indicates if the composite resource is ready"
              each:
                type: StateSet
                stateSet:
                  labelName: ready
                  path: [status, conditions, "[type=Ready]", status]
                  list: ["True", "False", "Unknown"]
            - name: "status_synced"
              help: "Indicates if the composite resource is synced"
              each:
                type: StateSet
                stateSet:
                  labelName: synced
                  path: [status, conditions, "[type=Synced]", status]
                  list: ["True", "False", "Unknown"]