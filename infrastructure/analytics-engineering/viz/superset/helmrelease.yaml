apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: superset
  namespace: superset
spec:
  interval: 5m
  chart:
    spec:
      chart: superset
      version: 0.14.0
      sourceRef:
        kind: HelmRepository
        name: superset
        namespace: flux-system
  valuesFrom:
  - kind: Secret
    name: redis
    valuesKey: password
    targetPath: supersetNode.connections.redis_password
  - kind: Secret
    name: postgres
    valuesKey: password
    targetPath: supersetNode.connections.db_pass
  values:
  # https://artifacthub.io/packages/helm/superset/superset
  # https://github.com/apache/superset/blob/master/helm/superset/values.yaml
    bootstrapScript: |
      # !/bin/bash
      # https://superset.apache.org/docs/configuration/databases/#supported-databases-and-dependencies
      # https://github.com/apache/superset/blob/master/pyproject.toml#L109

      pip install duckdb-engine psycopg2-binary

      if [ ! -f ~/bootstrap ]; then echo "Running Superset with uid {{ .Values.runAsUser }}" > ~/bootstrap; fi
    configOverrides:
      secret: |
        # Generated using "openssl rand -base64 42"
        SECRET_KEY = '4h5vd3fSz3jEpQneJaKNKK4CB+wHKaaWfom1PyiNKoCjs/EtbxvrzxJC'
    supersetNode:
      connections:
        redis_host: redis.superset.svc.cluster.local
        db_host: postgres.superset.svc.cluster.local
    postgresql:
      enabled: false
    redis:
      enabled: false